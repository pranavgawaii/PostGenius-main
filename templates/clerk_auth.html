<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Authentication - Post Genius</title>
  <script
    async
    crossorigin="anonymous"
    data-clerk-publishable-key="{{ clerk_publishable_key }}"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
    type="text/javascript"
  ></script>
  <style>
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #1D1D1D;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    #auth-container {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .logo {
        font-size: 32px;
        margin-bottom: 30px;
        color: #7c3aed;
        font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="auth-container">
    <div class="logo">Post Genius</div>
    <div id="clerk-auth"></div>
  </div>
  <script>
    window.addEventListener("load", async function () {
      await Clerk.load();

      if (Clerk.user) {
        // User is already signed in, sync with backend
        const token = await Clerk.session.getToken();
        try {
            const response = await fetch("{% url 'clerk_login_backend' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ token: token })
            });
            
            if (response.ok) {
                window.location.href = "{% url 'dashboard' %}";
            } else {
                console.error("Backend login failed");
                // Optional: Clerk.signOut();
            }
        } catch (e) {
            console.error("Error syncing session", e);
        }
      } else {
        const authDiv = document.getElementById("clerk-auth");
        Clerk.mountSignIn(authDiv, {
            afterSignInUrl: "{% url 'clerk_auth' %}",
            afterSignUpUrl: "{% url 'clerk_auth' %}",
            appearance: {
                baseTheme: 'dark'
            }
        });
      }
    });
  </script>
</body>
</html>
